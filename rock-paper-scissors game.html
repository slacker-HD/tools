<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AI手势识别石头剪刀布</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
        <!-- 引入TensorFlow.js和手势识别模型 -->
        <script src="./js/tf.min.js"></script>
        <script src="./js/handpose.min.js"></script>
        <script>
            var _hmt = _hmt || [];
            (function () {
                var hm = document.createElement("script");
                hm.src = "//hm.baidu.com/hm.js?767e3ea52a6b4f3c656cdd4119c87e62";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
            })();
        </script>
        <!-- 配置Tailwind自定义颜色和字体 -->
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: '#165DFF',
                            secondary: '#36D399',
                            danger: '#F87272',
                            neutral: '#1E293B',
                        },
                        fontFamily: {
                            inter: ['Inter', 'system-ui', 'sans-serif'],
                        },
                    }
                }
            }
        </script>

        <style type="text/tailwindcss">
            @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .animate-pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .animate-shake {
                animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            }
            .backdrop-blur {
                backdrop-filter: blur(8px);
            }
        }
        
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-3px); }
            40%, 60% { transform: translateX(3px); }
        }
    </style>
    </head>

    <body class="font-inter bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen text-neutral">
        <div class="container mx-auto px-4 py-8 max-w-5xl">
            <!-- 游戏标题 -->
            <header class="text-center mb-8">
                <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-bold text-primary text-shadow mb-2">
                    AI手势识别石头剪刀布
                </h1>
                <p class="text-gray-600 text-lg">展示你的手势，与电脑一决胜负！</p>
            </header>

            <!-- 加载模型提示 -->
            <div id="modelLoading"
                class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-primary/90 text-white px-4 py-2 rounded-full shadow-lg z-40 hidden">
                <i class="fa fa-circle-o-notch fa-spin mr-2"></i>
                <span>正在加载AI模型，请稍候...</span>
            </div>

            <!-- 游戏区域 -->
            <main class="flex flex-col lg:flex-row gap-8">
                <!-- 左侧：玩家区域 -->
                <div
                    class="w-full lg:w-1/2 bg-white rounded-xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl">
                    <div class="p-4 bg-primary text-white">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fa fa-user mr-2"></i> 玩家
                        </h2>
                    </div>

                    <!-- 摄像头区域 -->
                    <div class="relative">
                        <video id="playerVideo" class="w-full aspect-video object-cover bg-gray-800" autoplay
                            playsinline></video>
                        <canvas id="playerCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>

                        <!-- 加载状态覆盖层 -->
                        <div id="loadingOverlay"
                            class="absolute inset-0 bg-black/60 backdrop-blur flex flex-col items-center justify-center">
                            <div
                                class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4">
                            </div>
                            <p class="text-white text-lg">正在访问摄像头...</p>
                        </div>

                        <!-- 摄像头错误提示 -->
                        <div id="cameraError"
                            class="absolute inset-0 bg-black/60 backdrop-blur hidden flex-col items-center justify-center p-6">
                            <i class="fa fa-exclamation-triangle text-4xl text-danger mb-4"></i>
                            <h3 class="text-white text-xl font-semibold mb-2">无法访问摄像头</h3>
                            <p id="errorMessage" class="text-gray-300 mb-4 text-center">请检查您的摄像头权限设置</p>
                            <ul class="text-gray-300 text-left mb-6 space-y-2">
                                <li>1. 确保您的设备有可用摄像头</li>
                                <li>2. 检查浏览器是否被授予摄像头权限</li>
                                <li>3. 确保没有其他应用正在使用摄像头</li>
                            </ul>
                            <div class="flex gap-3">
                                <button id="retryCamera"
                                    class="bg-primary hover:bg-primary/90 text-white font-semibold py-2 px-6 rounded-lg transition-all">
                                    重试
                                </button>
                                <button id="showPermissionGuide"
                                    class="bg-gray-200 hover:bg-gray-300 text-neutral font-semibold py-2 px-6 rounded-lg transition-all">
                                    权限指南
                                </button>
                            </div>
                        </div>

                        <!-- 权限指南模态框 -->
                        <div id="permissionGuideModal"
                            class="fixed inset-0 bg-black/50 backdrop-blur hidden flex items-center justify-center z-50 p-4">
                            <div class="bg-white rounded-xl max-w-md w-full p-6 shadow-2xl">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold text-primary">如何开启摄像头权限</h3>
                                    <button id="closePermissionGuide" class="text-gray-500 hover:text-gray-700">
                                        <i class="fa fa-times text-xl"></i>
                                    </button>
                                </div>
                                <div class="space-y-4 text-gray-700">
                                    <div>
                                        <h4 class="font-semibold mb-2">Chrome浏览器</h4>
                                        <ol class="list-decimal pl-5 space-y-1">
                                            <li>点击地址栏左侧的"锁"图标</li>
                                            <li>在弹出的菜单中找到"摄像头"选项</li>
                                            <li>选择"允许"选项</li>
                                            <li>刷新页面使设置生效</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold mb-2">Edge浏览器</h4>
                                        <ol class="list-decimal pl-5 space-y-1">
                                            <li>点击地址栏左侧的"摄像头被阻止"图标</li>
                                            <li>点击"始终允许此站点使用摄像头"</li>
                                            <li>点击"完成"并刷新页面</li>
                                        </ol>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold mb-2">Firefox浏览器</h4>
                                        <ol class="list-decimal pl-5 space-y-1">
                                            <li>点击地址栏左侧的"信息"图标</li>
                                            <li>点击"权限"选项卡</li>
                                            <li>找到摄像头设置，选择"允许"</li>
                                            <li>刷新页面使设置生效</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 倒计时覆盖层 -->
                        <div id="countdownOverlay"
                            class="absolute inset-0 bg-black/40 backdrop-blur hidden flex items-center justify-center">
                            <p id="countdownText" class="text-white text-[clamp(3rem,10vw,6rem)] font-bold"></p>
                        </div>

                        <!-- 手部检测提示 -->
                        <div id="handDetectionHint"
                            class="absolute bottom-4 left-4 bg-black/60 text-white px-3 py-1 rounded-full text-sm hidden">
                            <i class="fa fa-hand-paper-o mr-1"></i> 请将手放在摄像头前
                        </div>
                    </div>

                    <!-- 玩家手势 -->
                    <div class="p-4 flex justify-center">
                        <div id="playerGesture" class="text-5xl py-2 px-6 border-2 border-gray-200 rounded-lg">
                            <i class="fa fa-question-circle"></i>
                        </div>
                    </div>
                </div>

                <!-- 右侧：电脑区域 -->
                <div
                    class="w-full lg:w-1/2 bg-white rounded-xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl">
                    <div class="p-4 bg-neutral text-white">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fa fa-robot mr-2"></i> 电脑
                        </h2>
                    </div>

                    <!-- 电脑显示区域 -->
                    <div class="aspect-video bg-gray-100 flex items-center justify-center">
                        <div id="computerGesture" class="text-8xl">
                            <i class="fa fa-question-circle text-gray-300"></i>
                        </div>
                    </div>

                    <!-- 电脑状态 -->
                    <div class="p-4 flex justify-center">
                        <p id="computerStatus" class="text-lg text-gray-600">等待游戏开始...</p>
                    </div>
                </div>
            </main>

            <!-- 游戏控制和结果 -->
            <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
                <!-- 分数显示 -->
                <div class="flex justify-center items-center gap-8 mb-6">
                    <div class="text-center">
                        <p class="text-gray-500 mb-1">玩家分数</p>
                        <p id="playerScore" class="text-4xl font-bold text-primary">0</p>
                    </div>
                    <div class="text-3xl font-bold">:</div>
                    <div class="text-center">
                        <p class="text-gray-500 mb-1">电脑分数</p>
                        <p id="computerScore" class="text-4xl font-bold text-neutral">0</p>
                    </div>
                </div>

                <!-- 游戏结果 -->
                <div id="gameResult" class="text-center py-4 mb-6 rounded-lg hidden">
                    <p id="resultText" class="text-xl font-semibold"></p>
                </div>

                <!-- 控制按钮 -->
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="startBtn"
                        class="bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-8 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center">
                        <i class="fa fa-play mr-2"></i> 开始游戏
                    </button>
                    <button id="resetBtn"
                        class="bg-gray-200 hover:bg-gray-300 text-neutral font-semibold py-3 px-8 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center"
                        disabled>
                        <i class="fa fa-refresh mr-2"></i> 重置游戏
                    </button>
                    <button id="helpBtn"
                        class="bg-gray-200 hover:bg-gray-300 text-neutral font-semibold py-3 px-8 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center">
                        <i class="fa fa-question-circle mr-2"></i> 游戏说明
                    </button>
                </div>
            </div>

            <!-- 游戏说明模态框 -->
            <div id="helpModal"
                class="fixed inset-0 bg-black/50 backdrop-blur hidden flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-xl max-w-md w-full p-6 shadow-2xl transform transition-all">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-primary">游戏说明</h3>
                        <button id="closeHelpBtn" class="text-gray-500 hover:text-gray-700">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="space-y-4 text-gray-700">
                        <p>1. 点击"开始游戏"按钮，授予摄像头权限</p>
                        <p>2. 倒计时结束时，请在摄像头前展示以下手势：</p>
                        <ul class="list-disc pl-5 space-y-2">
                            <li><strong>石头</strong>：握紧拳头</li>
                            <li><strong>剪刀</strong>：伸出食指和中指</li>
                            <li><strong>布</strong>：张开手掌</li>
                        </ul>
                        <p>3. AI会实时识别你的手势，并与电脑随机生成的手势比较</p>
                        <p>4. 遵循标准石头剪刀布规则判定胜负</p>
                        <p class="text-primary"><i class="fa fa-lightbulb-o mr-1"></i> 提示：确保光线充足，手部在摄像头中清晰可见</p>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-12 text-center text-gray-500 text-sm py-4">
            <p>AI手势识别石头剪刀布 &copy; 2023</p>
        </footer>

        <script>
            // DOM元素
            const playerVideo = document.getElementById('playerVideo');
            const playerCanvas = document.getElementById('playerCanvas');
            const playerGesture = document.getElementById('playerGesture');
            const computerGesture = document.getElementById('computerGesture');
            const computerStatus = document.getElementById('computerStatus');
            const playerScoreEl = document.getElementById('playerScore');
            const computerScoreEl = document.getElementById('computerScore');
            const gameResult = document.getElementById('gameResult');
            const resultText = document.getElementById('resultText');
            const startBtn = document.getElementById('startBtn');
            const resetBtn = document.getElementById('resetBtn');
            const helpBtn = document.getElementById('helpBtn');
            const helpModal = document.getElementById('helpModal');
            const closeHelpBtn = document.getElementById('closeHelpBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const cameraError = document.getElementById('cameraError');
            const errorMessage = document.getElementById('errorMessage');
            const retryCamera = document.getElementById('retryCamera');
            const countdownOverlay = document.getElementById('countdownOverlay');
            const countdownText = document.getElementById('countdownText');
            const modelLoading = document.getElementById('modelLoading');
            const handDetectionHint = document.getElementById('handDetectionHint');
            const showPermissionGuide = document.getElementById('showPermissionGuide');
            const permissionGuideModal = document.getElementById('permissionGuideModal');
            const closePermissionGuide = document.getElementById('closePermissionGuide');

            // Canvas上下文
            const ctx = playerCanvas.getContext('2d');

            // 游戏状态
            let gameState = {
                isPlaying: false,
                isModelLoaded: false,
                playerScore: 0,
                computerScore: 0,
                stream: null,
                model: null,
                detectionInterval: null,
                gestureHistory: [] // 记录手势识别历史，提高准确性
            };

            // 手势类型 - 修正了胜负关系
            const gestures = {
                rock: {
                    name: '石头',
                    icon: 'fa-hand-rock-o',
                    beats: 'scissors' // 石头赢剪刀
                },
                paper: {
                    name: '布',
                    icon: 'fa-hand-paper-o',
                    beats: 'rock' // 布赢石头
                },
                scissors: {
                    name: '剪刀',
                    icon: 'fa-hand-scissors-o',
                    beats: 'paper' // 剪刀赢布
                }
            };

            // 初始化事件监听
            function initEventListeners() {
                startBtn.addEventListener('click', startGame);
                resetBtn.addEventListener('click', resetGame);
                helpBtn.addEventListener('click', () => helpModal.classList.replace('hidden', 'flex'));
                closeHelpBtn.addEventListener('click', () => helpModal.classList.replace('flex', 'hidden'));
                retryCamera.addEventListener('click', startCamera);
                showPermissionGuide.addEventListener('click', () => {
                    permissionGuideModal.classList.replace('hidden', 'flex');
                });
                closePermissionGuide.addEventListener('click', () => {
                    permissionGuideModal.classList.replace('flex', 'hidden');
                });

                // 响应窗口大小变化，调整canvas尺寸
                window.addEventListener('resize', adjustCanvasSize);
            }

            // 加载AI模型
            async function loadAIModel() {
                try {
                    modelLoading.classList.remove('hidden');
                    gameState.model = await handpose.load();
                    gameState.isModelLoaded = true;
                    modelLoading.classList.add('hidden');
                    console.log('AI模型加载完成');
                } catch (err) {
                    console.error('模型加载失败:', err);
                    modelLoading.innerHTML = `
                    <i class="fa fa-exclamation-circle mr-2"></i>
                    <span>模型加载失败，请刷新页面重试</span>
                `;
                }
            }

            // 调整Canvas尺寸以匹配视频
            function adjustCanvasSize() {
                if (playerVideo.videoWidth) {
                    playerCanvas.width = playerVideo.videoWidth;
                    playerCanvas.height = playerVideo.videoHeight;
                }
            }

            // 启动摄像头
            async function startCamera() {
                // 隐藏错误提示，显示加载状态
                cameraError.classList.add('hidden');
                loadingOverlay.classList.remove('hidden');

                try {
                    // 检查浏览器是否支持媒体设备
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('您的浏览器不支持摄像头访问，请使用Chrome、Firefox或Edge等现代浏览器');
                    }

                    // 尝试不同的视频配置以提高兼容性
                    const videoConstraints = [
                        {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: 'user'
                        },
                        {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        },
                        { facingMode: 'user' },
                        true
                    ];

                    let stream = null;
                    let constraintIndex = 0;

                    // 尝试不同的视频配置，直到成功或全部失败
                    while (!stream && constraintIndex < videoConstraints.length) {
                        try {
                            stream = await navigator.mediaDevices.getUserMedia({
                                video: videoConstraints[constraintIndex]
                            });
                        } catch (innerErr) {
                            console.log(`尝试视频配置 ${constraintIndex} 失败:`, innerErr);
                            constraintIndex++;
                        }
                    }

                    if (!stream) {
                        throw new Error('所有视频配置尝试均失败，无法访问摄像头');
                    }

                    gameState.stream = stream;
                    playerVideo.srcObject = gameState.stream;

                    // 摄像头加载完成后隐藏加载覆盖层
                    playerVideo.onloadedmetadata = () => {
                        adjustCanvasSize();
                        loadingOverlay.classList.add('hidden');
                        startBtn.disabled = true;
                        resetBtn.disabled = false;
                        gameState.isPlaying = true;

                        // 开始手部检测
                        startHandDetection();

                        // 如果模型尚未加载，等待模型加载完成后开始游戏
                        if (gameState.isModelLoaded) {
                            startRound();
                        } else {
                            computerStatus.textContent = '等待AI模型加载...';
                            const checkModelInterval = setInterval(() => {
                                if (gameState.isModelLoaded) {
                                    clearInterval(checkModelInterval);
                                    startRound();
                                }
                            }, 500);
                        }
                    };
                } catch (err) {
                    console.error('无法访问摄像头:', err);

                    // 根据错误类型显示不同的消息
                    let errorMsg = '请确保已授予摄像头权限并检查设备是否正常工作';
                    if (err.name === 'NotAllowedError') {
                        errorMsg = '已拒绝摄像头权限，请在浏览器设置中启用';
                    } else if (err.name === 'NotFoundError') {
                        errorMsg = '未找到可用的摄像头设备';
                    } else if (err.name === 'NotReadableError') {
                        errorMsg = '摄像头被其他应用占用，请关闭后重试';
                    } else if (err.name === 'OverconstrainedError') {
                        errorMsg = '摄像头不支持所需的分辨率，尝试使用其他设备';
                    } else if (err.name === 'TypeError') {
                        errorMsg = '摄像头访问被阻止，请检查浏览器设置';
                    }

                    errorMessage.textContent = errorMsg;
                    loadingOverlay.classList.add('hidden');
                    cameraError.classList.remove('hidden');
                }
            }

            // 开始手部检测
            function startHandDetection() {
                if (gameState.detectionInterval) {
                    clearInterval(gameState.detectionInterval);
                }

                gameState.detectionInterval = setInterval(async () => {
                    if (!gameState.isPlaying || !gameState.model || countdownOverlay.classList.contains('hidden')) {
                        return;
                    }

                    try {
                        // 检测手部
                        const predictions = await gameState.model.estimateHands(playerVideo);
                        drawHandDetection(predictions);

                        // 如果检测到手，隐藏提示
                        if (predictions.length > 0) {
                            handDetectionHint.classList.add('hidden');
                        } else {
                            handDetectionHint.classList.remove('hidden');
                        }
                    } catch (err) {
                        console.error('手部检测出错:', err);
                    }
                }, 100);
            }

            // 绘制手部检测结果
            function drawHandDetection(predictions) {
                // 清除之前的绘制
                ctx.clearRect(0, 0, playerCanvas.width, playerCanvas.height);

                if (predictions.length > 0) {
                    // 绘制手部关键点
                    predictions.forEach(prediction => {
                        const landmarks = prediction.landmarks;

                        // 绘制连接点
                        const connections = [
                            [0, 1], [1, 2], [2, 3], [3, 4], // 拇指
                            [5, 6], [6, 7], [7, 8], // 食指
                            [9, 10], [10, 11], [11, 12], // 中指
                            [13, 14], [14, 15], [15, 16], // 无名指
                            [17, 18], [18, 19], [19, 20], // 小指
                            [0, 5], [5, 9], [9, 13], [13, 17], [0, 17] // 手掌
                        ];

                        ctx.strokeStyle = '#165DFF';
                        ctx.lineWidth = 3;

                        connections.forEach(connection => {
                            const [i, j] = connection;
                            const point1 = landmarks[i];
                            const point2 = landmarks[j];

                            ctx.beginPath();
                            ctx.moveTo(point1[0], point1[1]);
                            ctx.lineTo(point2[0], point2[1]);
                            ctx.stroke();
                        });

                        // 绘制关键点
                        ctx.fillStyle = '#36D399';
                        landmarks.forEach(landmark => {
                            ctx.beginPath();
                            ctx.arc(landmark[0], landmark[1], 5, 0, 2 * Math.PI);
                            ctx.fill();
                        });
                    });
                }
            }

            // 识别手势 - 优化算法提高准确性
            async function recognizeGesture() {
                if (!gameState.model) return null;

                try {
                    // 收集多个样本提高准确性
                    const samples = [];
                    for (let i = 0; i < 3; i++) {
                        const predictions = await gameState.model.estimateHands(playerVideo);
                        if (predictions.length > 0) {
                            samples.push(predictions[0].landmarks);
                        }
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }

                    if (samples.length === 0) {
                        return null; // 未检测到手
                    }

                    // 对多个样本进行分析
                    const gestureCounts = {
                        rock: 0,
                        paper: 0,
                        scissors: 0
                    };

                    samples.forEach(landmarks => {
                        // 计算各手指的弯曲程度（尖端与根部的Y坐标差）
                        const thumbBend = landmarks[4][1] - landmarks[2][1];
                        const indexBend = landmarks[8][1] - landmarks[5][1];
                        const middleBend = landmarks[12][1] - landmarks[9][1];
                        const ringBend = landmarks[16][1] - landmarks[13][1];
                        const pinkyBend = landmarks[20][1] - landmarks[17][1];

                        // 动态阈值调整，适应不同光线条件
                        const bendThreshold = Math.max(25, Math.min(40, Math.abs(thumbBend) / 2));

                        // 统计伸直的手指数量
                        let extendedFingers = 0;
                        if (indexBend < -bendThreshold) extendedFingers++; // 食指伸直
                        if (middleBend < -bendThreshold) extendedFingers++; // 中指伸直
                        if (ringBend < -bendThreshold) extendedFingers++; // 无名指伸直
                        if (pinkyBend < -bendThreshold) extendedFingers++; // 小指伸直

                        // 判断手势并计数
                        if (extendedFingers === 0) {
                            gestureCounts.rock++;
                        } else if (extendedFingers === 2 &&
                            indexBend < -bendThreshold &&
                            middleBend < -bendThreshold) {
                            gestureCounts.scissors++;
                        } else if (extendedFingers >= 3) {
                            gestureCounts.paper++;
                        }
                    });

                    // 选择出现次数最多的手势
                    let maxCount = -1;
                    let bestGesture = null;

                    Object.keys(gestureCounts).forEach(gesture => {
                        if (gestureCounts[gesture] > maxCount) {
                            maxCount = gestureCounts[gesture];
                            bestGesture = gestures[gesture];
                        }
                    });

                    // 如果没有明确结果，使用历史记录辅助判断
                    if (maxCount === 0 && gameState.gestureHistory.length > 0) {
                        return gameState.gestureHistory[gameState.gestureHistory.length - 1];
                    }

                    // 记录手势历史
                    if (bestGesture) {
                        gameState.gestureHistory.push(bestGesture);
                        if (gameState.gestureHistory.length > 5) {
                            gameState.gestureHistory.shift();
                        }
                    }

                    return bestGesture || getRandomGesture();

                } catch (err) {
                    console.error('手势识别出错:', err);
                    return null;
                }
            }

            // 开始游戏
            function startGame() {
                if (!gameState.isPlaying) {
                    // 首次启动时加载模型
                    if (!gameState.isModelLoaded) {
                        loadAIModel();
                    }
                    startCamera();
                } else {
                    startRound();
                }
            }

            // 开始新一轮
            function startRound() {
                // 重置UI
                playerGesture.innerHTML = '<i class="fa fa-question-circle"></i>';
                computerGesture.innerHTML = '<i class="fa fa-question-circle text-gray-300"></i>';
                gameResult.classList.add('hidden');
                computerStatus.textContent = '准备中...';
                handDetectionHint.classList.remove('hidden');

                // 显示倒计时
                countdownOverlay.classList.remove('hidden');
                let count = 3;
                countdownText.textContent = count;

                const countdownInterval = setInterval(() => {
                    count--;
                    countdownText.textContent = count;

                    if (count === 0) {
                        clearInterval(countdownInterval);
                        countdownText.textContent = '出!';

                        setTimeout(() => {
                            countdownOverlay.classList.add('hidden');
                            playRound();
                        }, 500);
                    }
                }, 1000);
            }

            // 进行一轮游戏
            async function playRound() {
                computerStatus.textContent = '识别手势中...';

                // 尝试多次识别，提高准确性
                let playerChoice = null;
                let attempts = 0;

                while (!playerChoice && attempts < 5) {
                    playerChoice = await recognizeGesture();
                    attempts++;
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // 如果无法识别，使用随机手势
                if (!playerChoice) {
                    playerChoice = getRandomGesture();
                    computerStatus.textContent = '识别困难，使用随机手势';
                } else {
                    computerStatus.textContent = '识别完成';
                }

                gameState.playerChoice = playerChoice;
                displayGesture(playerGesture, playerChoice);

                // 电脑随机选择手势 - 确保完全随机
                const computerChoice = getRandomGesture();
                displayGesture(computerGesture, computerChoice);

                // 延迟判断结果，增加紧张感
                setTimeout(() => {
                    determineWinner(playerChoice, computerChoice);
                }, 1000);
            }

            // 获取随机手势 - 确保均匀分布
            function getRandomGesture() {
                const gestureKeys = Object.keys(gestures);
                // 使用更均匀的随机算法
                const random = Math.random();
                const threshold = 1 / gestureKeys.length;

                for (let i = 0; i < gestureKeys.length; i++) {
                    if (random < (i + 1) * threshold) {
                        return gestures[gestureKeys[i]];
                    }
                }

                return gestures[gestureKeys[0]];
            }

            // 显示手势
            function displayGesture(element, gesture) {
                element.innerHTML = `<i class="fa ${gesture.icon}"></i>`;
                element.classList.add('animate-shake');

                setTimeout(() => {
                    element.classList.remove('animate-shake');
                }, 500);
            }

            // 判断胜负 - 修正核心逻辑
            function determineWinner(player, computer) {
                let result;

                // 明确的胜负判定逻辑
                if (player.name === computer.name) {
                    result = '平局!';
                    gameResult.className = 'text-center py-4 mb-6 rounded-lg bg-yellow-100';
                    resultText.className = 'text-xl font-semibold text-yellow-800';
                }
                // 玩家胜利条件（用beats属性判断）
                else if (
                    (player.beats && computer && computer.name && gestures[player.beats] && gestures[player.beats].name === computer.name)
                ) {
                    result = '你赢了!';
                    gameState.playerScore++;
                    gameResult.className = 'text-center py-4 mb-6 rounded-lg bg-secondary/20';
                    resultText.className = 'text-xl font-semibold text-secondary';
                }
                // 电脑胜利条件
                else {
                    result = '电脑赢了!';
                    gameState.computerScore++;
                    gameResult.className = 'text-center py-4 mb-6 rounded-lg bg-danger/20';
                    resultText.className = 'text-xl font-semibold text-danger';
                }

                // 更新UI
                resultText.textContent = `${result} 你的${player.name} vs 电脑的${computer.name}`;
                gameResult.classList.remove('hidden');
                playerScoreEl.textContent = gameState.playerScore;
                computerScoreEl.textContent = gameState.computerScore;
                computerStatus.textContent = '点击"开始游戏"进行下一轮';

                // 启用开始按钮
                startBtn.disabled = false;
            }

            // 重置游戏
            function resetGame() {
                // 停止视频流
                if (gameState.stream) {
                    gameState.stream.getTracks().forEach(track => track.stop());
                    gameState.stream = null;
                }

                // 停止手部检测
                if (gameState.detectionInterval) {
                    clearInterval(gameState.detectionInterval);
                    gameState.detectionInterval = null;
                }

                // 清除Canvas
                ctx.clearRect(0, 0, playerCanvas.width, playerCanvas.height);

                // 重置游戏状态
                gameState.isPlaying = false;
                gameState.playerScore = 0;
                gameState.computerScore = 0;
                gameState.gestureHistory = []; // 清空手势历史

                // 重置UI
                playerVideo.srcObject = null;
                playerGesture.innerHTML = '<i class="fa fa-question-circle"></i>';
                computerGesture.innerHTML = '<i class="fa fa-question-circle text-gray-300"></i>';
                playerScoreEl.textContent = '0';
                computerScoreEl.textContent = '0';
                gameResult.classList.add('hidden');
                computerStatus.textContent = '等待游戏开始...';
                loadingOverlay.classList.add('hidden');
                cameraError.classList.add('hidden');
                handDetectionHint.classList.add('hidden');

                // 重置按钮状态
                startBtn.disabled = false;
                resetBtn.disabled = true;
            }

            // 初始化应用
            function initApp() {
                initEventListeners();
            }

            // 启动应用
            document.addEventListener('DOMContentLoaded', initApp);
        </script>
    </body>

</html>
</body>

</html>