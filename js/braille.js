// DOMтЁЃу┤а
const dots = Array.from({ length: 6 }, (_, i) => document.getElementById(`dot${i + 1}`));
const currentChar = document.getElementById('currentChar');
const result = document.getElementById('result');
const clearBtn = document.getElementById('clearBtn');
const confirmBtn = document.getElementById('confirmBtn');
const inputModeRadios = document.getElementsByName('inputMode');

// тИЃУј▒тЈХуѓ╣жўхуіХТђЂ
let dotStates = new Array(6).fill(false);
let inputMode = 'ujmik';

// жћ«СйЇТўат░ё - уА«С┐ЮСИјТаЄтЄєтИЃУј▒тЈХуѓ╣СйЇСИђУЄ┤
const keyMaps = {
    ujmik: {
        'u': 0, // уѓ╣СйЇ 1 - тидСИі
        'j': 1, // уѓ╣СйЇ 2 - тидСИГ
        'm': 2, // уѓ╣СйЇ 3 - тидСИІ
        'i': 3, // уѓ╣СйЇ 4 - тЈ│СИі
        'k': 4, // уѓ╣СйЇ 5 - тЈ│СИГ
        ',': 5  // уѓ╣СйЇ 6 - тЈ│СИІ
    },
    numpad: {
        '7': 0, // уѓ╣СйЇ 1 - тидСИі
        '4': 1, // уѓ╣СйЇ 2 - тидСИГ
        '1': 2, // уѓ╣СйЇ 3 - тидСИІ
        '8': 3, // уѓ╣СйЇ 4 - тЈ│СИі
        '5': 4, // уѓ╣СйЇ 5 - тЈ│СИГ
        '2': 5  // уѓ╣СйЇ 6 - тЈ│СИІ
    },
    rfvedc: {
        'e': 0, // уѓ╣СйЇ 1 - тидСИі
        'd': 1, // уѓ╣СйЇ 2 - тидСИГ
        'c': 2, // уѓ╣СйЇ 3 - тидСИІ
        'r': 3, // уѓ╣СйЇ 4 - тЈ│СИі
        'f': 4, // уѓ╣СйЇ 5 - тЈ│СИГ
        'v': 5  // уѓ╣СйЇ 6 - тЈ│СИІ
    }
};

// // уѓ╣жўхСИјтГЌугдТўат░ё - уА«С┐ЮСИјТаЄтЄєтИЃУј▒тЈХуѓ╣СйЇСИђУЄ┤
// const brailleMap = {
//     // уЕ║Та╝тњїУй╗тБ░
//     '000000': ['Рађ', 'Уй╗тБ░'],      // уЕ║Та╝/Уй╗тБ░
//     // УІ▒ТќЄтГЌТ»ЇТўат░ё
//     '100000': ['a'],            // РаЂ a
//     '110000': ['b'],            // РаЃ b
//     '100100': ['c'],            // РаЅ c
//     '100110': ['d'],            // РаЎ d
//     '100010': ['e'],            // РаЉ e
//     '110100': ['f'],            // РаІ f
//     '110110': ['g'],            // РаЏ g
//     '110010': ['h'],            // РаЊ h
//     '010100': ['i'],            // Раі i
//     '010110': ['j'],            // Раџ j
//     '101000': ['k'],            // РаЁ k
//     '111000': ['l'],            // РаЄ l
//     '101100': ['m'],            // РаЇ m
//     '101110': ['n'],            // РаЮ n
//     '101010': ['o'],            // РаЋ o
//     '111100': ['p'],            // РаЈ p
//     '111110': ['q'],            // РаЪ q
//     '111010': ['r'],            // РаЌ r
//     '011100': ['s'],            // Рај s
//     '011110': ['t'],            // Раъ t
//     '101001': ['u'],            // РаЦ u
//     '111001': ['v'],            // РаД v
//     '010111': ['w'],            // Ра║ w
//     '101101': ['x'],            // РаГ x
//     '101111': ['y'],            // Рай y
//     '101011': ['z'],            // Рах z

//     // тБ░Т»ЇжЃетѕє - тЈїУ»╗жЪ│тБ░Т»Ї№╝ѕСИјжЪхТ»Їу╗ётљѕУДётѕЎ№╝Ѕ
//     '110110': ['g(ТГї)/j(Тю║)'],     // РаЏ g/j: gућеС║јa/o/eуГЅ№╝їjућеС║јi/├╝ - 1245уѓ╣
//     '101000': ['k(уДЉ)/q(ТюЪ)'],     // РаЁ k/q: kућеС║јa/o/eуГЅ№╝їqућеС║јi/├╝ - 13уѓ╣
//     '110010': ['h(тќЮ)/x(УЦ┐)'],     // РаЊ h/x: hућеС║јa/o/eуГЅ№╝їxућеС║јi/├╝ - 125уѓ╣
//     '110000': ['b(ТњГ)'],           // РаЃ b - 12уѓ╣
//     '111100': ['p(тЮА)'],           // РаЈ p - 1234уѓ╣
//     '101100': ['m(ТЉИ)'],           // РаЇ m - 134уѓ╣
//     '110100': ['f(СйЏ)'],           // РаІ f - 124уѓ╣
//     '100110': ['d(тЙЌ)'],           // РаЎ d - 145уѓ╣
//     '011110': ['t(уЅ╣)'],           // Раъ t - 2345уѓ╣
//     '101110': ['n(У«и)'],           // РаЮ n - 1345уѓ╣
//     '111000': ['l(тІњ)'],           // РаЄ l - 123уѓ╣
//     '001100': ['zh(уЪЦ)'],          // Раї zh - 34уѓ╣
//     '111110': ['ch(тљЃ)'],          // РаЪ ch - 12345уѓ╣
//     '110001': ['sh(У»Ќ)'],          // Ра▒ sh - 156уѓ╣
//     '010110': ['r(ТЌЦ)'],           // Раџ r - 245уѓ╣
//     '101011': ['z(тГљ)'],           // Рах z - 1356уѓ╣
//     '100100': ['c(У»Ї)'],           // РаЅ c - 14уѓ╣
//     '011100': ['s(ТђЮ)'],           // Рај s - 234уѓ╣

//     // ТЋ░тГЌ№╝ѕСй┐ућеТЋ░тГЌУ«░тЈи + тГЌТ»Їa-j№╝Ѕ
//     '001111': ['#'],            // Ра╝ ТЋ░тГЌУ«░тЈи
//     '100000': ['1'],            // РаЂ 1 (ТЋ░тГЌУ«░тЈи + a)
//     '110000': ['2'],            // РаЃ 2 (ТЋ░тГЌУ«░тЈи + b)
//     '100100': ['3'],            // РаЅ 3 (ТЋ░тГЌУ«░тЈи + c)
//     '100110': ['4'],            // РаЎ 4 (ТЋ░тГЌУ«░тЈи + d)
//     '100010': ['5'],            // РаЉ 5 (ТЋ░тГЌУ«░тЈи + e)
//     '110100': ['6'],            // РаІ 6 (ТЋ░тГЌУ«░тЈи + f)
//     '110110': ['7'],            // РаЏ 7 (ТЋ░тГЌУ«░тЈи + g)
//     '110010': ['8'],            // РаЊ 8 (ТЋ░тГЌУ«░тЈи + h)
//     '010100': ['9'],            // Раі 9 (ТЋ░тГЌУ«░тЈи + i)
//     '010110': ['0'],            // Раџ 0 (ТЋ░тГЌУ«░тЈи + j)
//     // ТЋ░тГЌ№╝ѕ1-9,0 тЁежЃеСИІуД╗СИђТа╝т«ъуј░тюєтюѕТЋ░тГЌТЋѕТъю№╝Ѕ
//     '010000': ['РЉа'],            // Раѕ тюєтюѕ1 (2)
//     '011000': ['РЉА'],            // Раў тюєтюѕ2 (2,3)
//     '010100': ['РЉб'],            // Раі тюєтюѕ3 (2,5)
//     '010110': ['РЉБ'],            // Раџ тюєтюѕ4 (2,5,6)
//     '010010': ['РЉц'],            // Рањ тюєтюѕ5 (2,6)
//     '011100': ['РЉЦ'],            // Раю тюєтюѕ6 (2,3,5)
//     '011110': ['РЉд'],            // Раъ тюєтюѕ7 (2,3,5,6)
//     '011010': ['РЉД'],            // Ра▓ тюєтюѕ8 (2,3,6)
//     '001100': ['РЉе'],            // Рає тюєтюѕ9 (3,5)
//     '001110': ['­ЪёІ'],            // Раќ тюєтюѕ0 (3,5,6)

//     // жЪхТ»ЇжЃетѕє - у«ђтЇЋжЪхТ»Ї
//     '000101': ['a(тЋі)'],          // Раћ жЪхТ»Їa - 35уѓ╣
//     '001010': ['o/e(тЊд/жбЮ)'],     // Раб жЪхТ»Їo/e - 26уѓ╣
//     '010100': ['i(УАБ)'],          // Раі жЪхТ»Їi - 24уѓ╣
//     '101001': ['u(С╣ї)'],          // РаЦ жЪхТ»Їu - 136уѓ╣
//     '001110': ['├╝(ж▒╝)'],          // Раг жЪхТ»Ї├╝ - 346уѓ╣
//     '111010': ['er(тё┐)'],         // РаЌ жЪхТ»Їer - 1235уѓ╣

//     // жЪхТ»ЇжЃетѕє - тцЇжЪхТ»Ї
//     '010110': ['ai(уѕ▒)'],         // Раф жЪхТ»Їai - 246уѓ╣
//     '011010': ['ao(тЦЦ)'],         // Раќ жЪхТ»Їao - 235уѓ╣
//     '011110': ['ei(У»Х)'],         // Ра« жЪхТ»Їei - 2346уѓ╣
//     '111011': ['ou(ТгД)'],         // Раи жЪхТ»Їou - 12356уѓ╣
//     '110100': ['ia(тЉђ)'],         // РаФ жЪхТ»Їia - 1246уѓ╣
//     '100010': ['ie(УђХ)'],         // РаЉ жЪхТ»Їie - 15уѓ╣
//     '111111': ['ua(тЊЄ)'],         // Ра│ жЪхТ»Їua - 123456уѓ╣
//     '001110': ['iao(тдќ)'],        // Раю жЪхТ»Їiao - 345уѓ╣
//     '101010': ['iu(С╝ў)'],         // РаЋ жЪхТ»Їiu - 1256уѓ╣
//     '011100': ['ui(теЂ)'],         // Ра╗ жЪхТ»Їui - 2456уѓ╣

//     // жЪхТ»ЇжЃетѕє - ж╝╗жЪхТ»Ї
//     '001110': ['ang(Тўѓ)'],        // Рањ жЪхТ»Їang - 236уѓ╣
//     '001111': ['eng(жъЦ)'],        // Раћ жЪхТ»Їeng - 3456уѓ╣
//     '101101': ['iang(тц«)'],       // Рад жЪхТ»Їiang - 1346уѓ╣
//     '000011': ['ing(УІ▒)'],        // Раѓ жЪхТ»Їing - 16уѓ╣
//     '011110': ['uang(Т▒ф)'],       // Ра┤ жЪхТ»Їuang - 2356уѓ╣
//     '000110': ['ong(Уй░)'],        // Раа жЪхТ»Їong - 256уѓ╣
//     '100110': ['ian(уЃЪ)'],        // Рад жЪхТ»Їian - 146уѓ╣
//     '110010': ['in(тЏа)'],         // Раѓ жЪхТ»Їin - 126уѓ╣
//     '111100': ['uan(т╝»)'],        // Ра╝ жЪхТ»Їuan - 12456уѓ╣ 
//     '001010': ['uen(ТИЕ)'],        // Рае жЪхТ»Їuen - 25уѓ╣
//     '111010': ['├╝an(тєц)'],        // РаИ жЪхТ»Ї├╝an - 12346уѓ╣
//     '110110': ['iong(ТІЦ)'],       // РаИ жЪхТ»Їiong - 1456уѓ╣

//     // тБ░У░ЃжЃетѕє
//     '100000': ['тБ░У░Ѓ:жў┤т╣│', 'РаЂ'],    // РаЂ 1уѓ╣ - жў┤т╣│(╦Ѕ) тдѓ"тдѕm─Ђ"
//     '010000': ['тБ░У░Ѓ:жў│т╣│', 'Раѓ'],    // Раѓ 2уѓ╣ - жў│т╣│(╦і) тдѓ"ж║╗m├А"
//     '001000': ['тБ░У░Ѓ:СИітБ░', 'Раё'],    // Раё 3уѓ╣ - СИітБ░(╦Є) тдѓ"жЕгmКј"
//     '011000': ['тБ░У░Ѓ:тј╗тБ░', 'Рає'],    // Рає 23уѓ╣ - тј╗тБ░(╦І) тдѓ"жфѓm├а"
// };
const brailleMap = {
    '000000': ['Рађ', 'Уй╗тБ░'],      // уЕ║Та╝/Уй╗тБ░

    '100000': ['a', '1', 'тБ░У░Ѓ:жў┤т╣│', 'РаЂ'],            // РаЂ a, 1, жў┤т╣│
    '110000': ['b', '2'],            // РаЃ b, 2
    '100100': ['c', '3', 'РЉб', 'c(У»Ї)'],            // РаЅ c, 3, тюєтюѕ3, c(У»Ї)
    '100110': ['d', '4', 'd(тЙЌ)', 'ian(уЃЪ)'],            // РаЎ d, 4, d(тЙЌ), ian(уЃЪ)
    '100010': ['e', '5', 'ie(УђХ)'],            // РаЉ e, 5, ie(УђХ)
    '110100': ['f', '6', 'f(СйЏ)', 'ia(тЉђ)', 'iu(С╝ў)'],            // РаІ f, 6, f(СйЏ), ia(тЉђ), iu(С╝ў)
    '110110': ['g', '7', 'g(ТГї)/j(Тю║)', 'iang(тц«)', 'iong(ТІЦ)'],            // РаЏ g, 7, g/j, iang, iong
    '110010': ['h', '8', 'h(тќЮ)/x(УЦ┐)', 'in(тЏа)', 'РЉД'],            // РаЊ h, 8, h/x, in, тюєтюѕ8
    '010100': ['i', '9', 'РЉб', 'i(УАБ)', 'ei(У»Х)', '├╝an(тєц)'],            // Раі i, 9, тюєтюѕ3, i, ei, ├╝an
    '010110': ['j', '0', 'r(ТЌЦ)', 'ai(уѕ▒)', 'iao(тдќ)', 'ing(УІ▒)'],            // Раџ j, 0, r, ai, iao, ing
    
    '101000': ['k', 'k(уДЉ)/q(ТюЪ)'],            // РаЁ k, k/q
    '111000': ['l', 'l(тІњ)'],            // РаЄ l, l(тІњ)
    '101100': ['m', 'm(ТЉИ)'],            // РаЇ m, m(ТЉИ)
    '011100': ['s', 'РЉЦ', 's(ТђЮ)', 'ui(теЂ)', 'uang(Т▒ф)'],            // Рај s, тюєтюѕ6, s(ТђЮ), ui, uang
    '101001': ['u', 'u(С╣ї)'],            // РаЦ u, u(С╣ї)
    '010111': ['w'],            // Ра║ w
    '101101': ['x', 'iang(тц«)'],            // РаГ x, iang(тц«)
    '101111': ['y'],            // Рай y
    '101011': ['z', 'z(тГљ)'],            // Рах z, z(тГљ)

    '111100': ['p', 'p(тЮА)', 'uan(т╝»)'],           // РаЈ p, p(тЮА), uan(т╝»)
    '111110': ['q', 'ch(тљЃ)', 'РЉд'],           // РаЪ q, ch(тљЃ), тюєтюѕ7
    '110001': ['sh(У»Ќ)'],          // Ра▒ sh - 156уѓ╣
    '001100': ['zh(уЪЦ)', 'РЉе'],          // Раї zh - 34уѓ╣, тюєтюѕ9
    '001111': ['#', 'eng(жъЦ)'],            // Ра╝ ТЋ░тГЌУ«░тЈи, eng(жъЦ)

    '010000': ['РЉа', 'тБ░У░Ѓ:жў│т╣│', 'Раѓ'],            // Раѕ тюєтюѕ1, жў│т╣│
    '011000': ['РЉА', 'тБ░У░Ѓ:тј╗тБ░', 'Рає'],            // Раў тюєтюѕ2, тј╗тБ░
    '010010': ['РЉц'],            // Рањ тюєтюѕ5
    '011010': ['РЉД', 'ao(тЦЦ)', 'ou(ТгД)'],            // Ра▓ тюєтюѕ8, ao(тЦЦ), ou(ТгД)
    '001110': ['├╝', '­ЪёІ', 'iao(тдќ)', 'ang(Тўѓ)', 'ong(Уй░)'],            // Раг жЪхТ»Ї├╝, тюєтюѕ0, iao, ang, ong

    '000101': ['a(тЋі)'],          // Раћ жЪхТ»Їa - 35уѓ╣
    '001010': ['o/e(тЊд/жбЮ)', 'uen(ТИЕ)'],     // Раб жЪхТ»Їo/e, uen(ТИЕ)
    '111010': ['er(тё┐)', 'r(ТЌЦ)', '├╝an(тєц)'],         // РаЌ жЪхТ»Їer, r(ТЌЦ), ├╝an(тєц)
    '011110': ['t', 't(уЅ╣)', 'ei(У»Х)', 'ou(ТгД)', 'iong(ТІЦ)'],         // Раъ t, t(уЅ╣), ei, ou, iong
    '111011': ['ou(ТгД)'],         // Раи жЪхТ»Їou - 12356уѓ╣
    '111111': ['ua(тЊЄ)'],         // Ра│ жЪхТ»Їua - 123456уѓ╣
    '101010': ['iu(С╝ў)'],         // РаЋ жЪхТ»Їiu - 1256уѓ╣
    '000011': ['ing(УІ▒)'],        // Раѓ жЪхТ»Їing - 16уѓ╣
    '000110': ['ong(Уй░)'],        // Раа жЪхТ»Їong - 256уѓ╣
    '110010': ['in(тЏа)'],         // Раѓ жЪхТ»Їin - 126уѓ╣

    '001000': ['тБ░У░Ѓ:СИітБ░', 'Раё'],    // Раё 3уѓ╣ - СИітБ░(╦Є)
};


// СИ║ТЅђТюЅтЈ»УЃйуџёуѓ╣СйЇу╗ётљѕућЪТѕљуЏ▓ТќЄтГЌугдТўат░ё - С┐«ТГБуѓ╣СйЇу╝ќуаЂжђ╗УЙЉ
function generateAllBrailleDots() {
    const allDots = {};

    // тИЃУј▒тЈХуѓ╣СйЇу╝ќуаЂТЮЃжЄЇ
    const dotWeights = [1, 2, 4, 8, 16, 32];

    // жЂЇтјєТЅђТюЅтЈ»УЃйуџёуѓ╣СйЇу╗ётљѕ (0-63)
    for (let i = 0; i < 64; i++) {
        // ућЪТѕљС║їУ┐ЏтѕХУАеуц║
        let binary = i.toString(2).padStart(6, '0');

        // У«Ау«ЌUnicodeуаЂуѓ╣
        let codePoint = 0x2800;
        for (let j = 0; j < 6; j++) {
            if (binary[j] === '1') {
                codePoint += dotWeights[j];
            }
        }

        // тГўтѓеТўат░ётЁ│у│╗
        allDots[binary] = String.fromCodePoint(codePoint);
    }

    return allDots;
}

// С┐«Тћ╣ brailleDots СИ║тїЁтљФТЅђТюЅу╗ётљѕуџёТўат░ё
const brailleDots = generateAllBrailleDots();

// ТЏ┤Тќ░уѓ╣СйЇТўЙуц║ - С┐«ТГБUIуѓ╣СйЇТјњтѕЌ
function updateDotDisplay() {
    // уѓ╣СйЇжА║т║Ј№╝џтидСИі(1), тидСИГ(2), тидСИІ(3), тЈ│СИі(4), тЈ│СИГ(5), тЈ│СИІ(6)
    const dotPositions = [
        { top: '10%', left: '20%' },  // уѓ╣СйЇ1 - тидСИі
        { top: '45%', left: '20%' },  // уѓ╣СйЇ2 - тидСИГ
        { top: '80%', left: '20%' },  // уѓ╣СйЇ3 - тидСИІ
        { top: '10%', left: '70%' },  // уѓ╣СйЇ4 - тЈ│СИі
        { top: '45%', left: '70%' },  // уѓ╣СйЇ5 - тЈ│СИГ
        { top: '80%', left: '70%' }   // уѓ╣СйЇ6 - тЈ│СИІ
    ];

    // ТЏ┤Тќ░Т»ЈСИфуѓ╣СйЇуџёСйЇуй«тњїуіХТђЂ
    dots.forEach((dot, i) => {
        // У«Йуй«уѓ╣СйЇСйЇуй«
        dot.style.top = dotPositions[i].top;
        dot.style.left = dotPositions[i].left;

        // У«Йуй«уѓ╣СйЇуіХТђЂ
        dot.style.borderColor = dotStates[i] ? '#9333EA' : '#D1D5DB';
        dot.style.backgroundColor = dotStates[i] ? '#9333EA' : 'transparent';
    });

    // ТЏ┤Тќ░тйЊтЅЇтГЌугдТўЙуц║
    const dotString = dotStates.map(d => d ? '1' : '0').join('');
    const chars = brailleMap[dotString];
    if (chars) {
        const displayText = chars.filter(c => c !== null).join('/');
        currentChar.textContent = displayText || 'У»иТїЅжћ«УЙЊтЁЦ';
    } else {
        currentChar.textContent = 'У»иТїЅжћ«УЙЊтЁЦ';
    }
}

// тѕЄТЇбуѓ╣СйЇуіХТђЂ
function toggleDot(index) {
    dotStates[index] = !dotStates[index];
    updateDotDisplay();
}

// ТИЁжЎцуѓ╣СйЇ
function clearDots() {
    dotStates.fill(false);
    updateDotDisplay();
}

// ТЏ┤Тќ░DOMтЁЃу┤аУјитЈќ
const brailleResult = document.getElementById('brailleResult');

// С┐«Тћ╣ТИЁжЎцу╗ЊТъютЄйТЋ░
function clearResult() {
    brailleResult.value = '';
}

// Ти╗тіатЁЅТаЄСйЇуй«С┐ЮтГў
let savedCursorPos = null;

// Тх«тіеуфЌтЈБТјДтѕХтЄйТЋ░
let isInputting = false;

function showPopup() {
    isInputting = true;
    // С┐ЮтГўтйЊтЅЇтЁЅТаЄСйЇуй«
    savedCursorPos = brailleResult.selectionStart;
    braillePopup.classList.remove('opacity-0', 'pointer-events-none');
    braillePopup.classList.add('opacity-100');
    brailleResult.blur(); // уД╗жЎцТќЄТюгТАєуёдуѓ╣
}

function hidePopup() {
    isInputting = false;
    braillePopup.classList.add('opacity-0', 'pointer-events-none');
    braillePopup.classList.remove('opacity-100');
    // ТЂбтцЇтЁЅТаЄСйЇуй«
    if (savedCursorPos !== null) {
        brailleResult.focus();
        brailleResult.setSelectionRange(savedCursorPos, savedCursorPos);
    }
}

// С┐«Тћ╣уА«У«цУЙЊтЁЦтЄйТЋ░
function confirmInput() {
    const dotString = dotStates.map(d => d ? '1' : '0').join('');
    const brailleChar = brailleDots[dotString];

    if (brailleChar && savedCursorPos !== null) {
        const before = brailleResult.value.slice(0, savedCursorPos);
        const after = brailleResult.value.slice(savedCursorPos);
        brailleResult.value = before + brailleChar + after;

        savedCursorPos++;
        brailleResult.setSelectionRange(savedCursorPos, savedCursorPos);

        clearDots();
        hidePopup();
        return true;
    }
    return false;
}

// С┐«Тћ╣жћ«уЏўС║ІС╗Хтцёуљє
document.addEventListener('keydown', (e) => {
    const key = e.key.toLowerCase();
    const code = e.code;
    const mode = document.querySelector('input[name="inputMode"]:checked').value;

    // уЏ┤ТјЦУЙЊтЁЦуЕ║Та╝
    if (key === ' ' || (key === '0' && code === 'Numpad0')) {
        e.preventDefault();
        if (isInputting) {
            confirmInput();
        } else {
            const pos = brailleResult.selectionStart;
            const before = brailleResult.value.slice(0, pos);
            const after = brailleResult.value.slice(pos);
            brailleResult.value = before + 'Рађ' + after;  // Сй┐ућеуЏ▓ТќЄуЕ║Та╝тГЌугд
            brailleResult.setSelectionRange(pos + 1, pos + 1);
        }
        return;
    }

    // тдѓТъюТГБтюеуѓ╣СйЇУЙЊтЁЦТѕќТїЅСИІС║єТўат░ёжћ«
    if (isInputting || keyMaps[mode][key] !== undefined) {
        e.preventDefault();
        if (key === 'escape') {
            hidePopup();
            clearDots();
        } else if (keyMaps[mode][key] !== undefined) {
            showPopup();
            toggleDot(keyMaps[mode][key]);
        } else if (key === 'enter') {
            if (dotStates.some(state => state)) {
                confirmInput();
            }
            const before = brailleResult.value.slice(0, savedCursorPos);
            const after = brailleResult.value.slice(savedCursorPos);
            brailleResult.value = before + '\n' + after;
            savedCursorPos++;
            brailleResult.setSelectionRange(savedCursorPos, savedCursorPos);
        }
    }
});

// С┐«Тћ╣ТќЄТюгТАєС║ІС╗Хтцёуљє
brailleResult.addEventListener('input', (e) => {
    if (isInputting) {
        e.preventDefault();
        return;
    }

    const input = e.target;
    const text = input.value;
    const start = input.selectionStart;
    let validBrailleText = '';
    let cursorPos = start;

    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if (char === '\n' || (char >= 'Рађ' && char <= 'РБ┐')) {
            validBrailleText += char;
        } else if (i < start) {
            cursorPos--;
        }
    }

    input.value = validBrailleText;
    input.setSelectionRange(cursorPos, cursorPos);
});

// жў▓ТГбтюеУЙЊтЁЦТеАт╝ЈТЌХтц▒тј╗уёдуѓ╣
brailleResult.addEventListener('focus', (e) => {
    if (isInputting) {
        e.target.blur();
    }
});

// С║ІС╗ХуЏЉтљг
clearBtn.addEventListener('click', clearDots);
confirmBtn.addEventListener('click', confirmInput);
inputModeRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
        inputMode = e.target.value;
        clearDots();
    });
});

// тѕЮтДІтїќТЌХтѕЏт╗║тЈїУАїТўЙуц║
window.addEventListener('DOMContentLoaded', () => {
    clearResult();
    updateDotDisplay();
});
